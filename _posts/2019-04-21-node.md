---
layout: post
title: "我是怎么把50ms内的node接口耗时从53%提升到76%的"
subtitle: 'Node Time-Consuming'
author: "markzhang"
header-style: text
tags:
  - Node
---

在我所在的团队Node主要是用于提供接口数据和页面渲染。既然文章标题是和node接口耗时相关的，我先讲一下我们node是如何做接口数据提供的。

前端页面要想拿到数据，主要会经历三层，node->后端->核心数据。这三层都是属于内网调用，互相之间各有nginx进行调度。

所以从以上三层结构来看，想要提升node接口耗时，就是对内（node自身）处理逻辑和对外（后端及核心数据）交互过程进行优化。

### node处理逻辑进行优化
1、将串行网络请求改为并行网络请求，这一点非常重要，但有时候也容易被忽略，将网络请求改为并行之后会发现接口耗时下降明显。
```javascript
// 串行
let test = async () => {
  let res1 = await request(url1);
  let res2 = await request(url2);
  return [res1, res2];
};

// 并行
let test = async () => {
  let res = await Promise.all([
    request(url1),
    request(url2)
  ]);
  return res;
};
```

2、请求后端数据时采用持久连接
```javascript
// 以下是axios的例子
let http = require('http');
let httpAgent = new http.Agent({keepAlive: true});
let axios = require('axios');
axios({httpAgent}).then(/******/).catch(/******/);
```

3、避免与后端做重复工作。由于历史原因，当初团队建立node项目迁移接口时会参考以前后端同学的代码，故而导致一些代码逻辑里面做了与后端同学一样的重复工作。从我们项目来看，发现比较多的情况是在node和后端都调用了公司登录校验的接口，在node层去掉一次校验之后，耗时大概下降了5-6ms。

4、