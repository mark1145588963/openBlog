---
layout: post
title: "å‰ç«¯é¡¹ç›®å¼€å‘ï¼šä»£ç†ðŸš€"
subtitle: 'FE Project, Proxy'
author: "markzhang"
header-style: text
tags:
  - FE Engineering
---

ä¸Šä¸€ç¯‡æ–‡ç« å¤§æ¦‚è®²è¿°äº†jsé¡¹ç›®å¼€å‘çš„æ•´ä½“æµç¨‹ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ç€é‡è®²è§£å…³äºŽä»£ç†çš„éƒ¨åˆ†ã€‚

å…ˆæ•´ä½“è®²ä¸€ä¸‹å…³äºŽä»£ç†çš„è¿‡ç¨‹ï¼š
* é¦–å…ˆæˆ‘ä»¬å…ˆç”¨expressï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„nodeæœåŠ¡æ¡†æž¶ï¼‰åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ªserveræœåŠ¡ã€‚
* å°†é™æ€èµ„æºçš„hostæ˜ å°„åˆ°æœ¬åœ°ï¼Œæ¯”å¦‚æµ‹è¯•çŽ¯å¢ƒé™æ€èµ„æºç½‘å€æ˜¯m.asset.comï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä¿®æ”¹hostçš„å·¥å…·switchhostä¿®æ”¹m.asset.comçš„hostä¸º127.0.0.1ã€‚
* åœ¨æœ¬åœ°çš„serveræœåŠ¡å¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œå°†è¯·æ±‚æ‰“åˆ°æœ¬åœ°webpackæ‰“åŒ…æœåŠ¡ä¸Šï¼ŒèŽ·å–å¯¹åº”çš„jsèµ„æºï¼Œç„¶åŽè¿”å›žç»™æµè§ˆå™¨ã€‚

æŽ¥ä¸‹æ¥æ˜¯å®žçŽ°è¿™ä¸ªä»£ç†æœåŠ¡çš„ä¸å®Œå…¨ä»£ç ï¼Œä½†æ˜¯åŒ…æ‹¬äº†æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚

```javascript
let express = require('express'),
    proxy = require('http-proxy-middleware');

let app = express();

if (process.env.PROTOCOL_ENV === 'https') {
    httpsCreate();
} else {
    httpCreate();
}

function beforeProxy() {

}

// httpçš„å¯åŠ¨æœåŠ¡
function httpCreate() {
    app.use('/', (req, res, next) => {
        res.header('Access-Control-Allow-Origin', '*');
        next();
    });

    // cssé™æ€èµ„æºåŸŸåå’Œjsä¸€æ ·ï¼Œé€šè¿‡ä¿®æ”¹åŸŸåçš„æ–¹å¼
    // ç›´æŽ¥è¯·æ±‚å¯¹åº”çŽ¯å¢ƒçš„èµ„æºï¼Œè¦ä¹ˆæ˜¯ä¸ºä¿®æ”¹ä¹‹åŽçš„åŸŸåç»‘å®šäº†hostï¼Œè¦ä¹ˆä¸ºè¿™ä¸ªhoståšè‡ªåŠ¨æ˜ å°„
    app.use('/other_asset', beforeProxy('/other_asset'));

    // æœ¬åœ°å¯åŠ¨çš„pc jsæ‰“åŒ…æœåŠ¡
    app.use('/js/pc', proxy('http://localhost:9090/js/pc'));

    // æœ¬åœ°å¯åŠ¨çš„h5 jsæ‰“åŒ…æœåŠ¡
    app.use('/js/h5', proxy('http://localhost:3002/js/h5'));

    app.listen(80, 'm.asset.com', (err) => {
        // è¿™é‡Œå¯åŠ¨æœåŠ¡çš„æ—¶å€™éœ€è¦ç¡®ä¿èƒ½å¤Ÿæ‰¾åˆ°m.asset.comçš„host
        // ä¸ç„¶å¯åŠ¨ä¼šæŠ¥é”™
        if (err) {
            console.log(err);
            return;
        }
    });
}

// httpsçš„å¯åŠ¨æœåŠ¡
let fs = require('fs'),
    https = require('https'),
    path = require('path'),
    options = {
        key: fs.readFileSync(path.join(__dirname, '../key.pem')),
        cert: fs.readFileSync(path.join(__dirname, '../cert.pem'))
    };
let httpsServer;
function httpsCreate() {
    // é˜²æ­¢ä»£ç†è¯·æ±‚httpsåœ°å€æ—¶ï¼Œhttpsè¯ä¹¦ä¸è¢«ä¿¡ä»»è€Œè¢«æ‹¦æˆª
    // å¦‚æžœä¸è®¾ç½®è¿™ä¸ªçŽ¯å¢ƒå˜é‡ï¼Œä¼šå‡ºçŽ°CERT_UNTRUSTEDé—®é¢˜
    process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";
    
    app.use('/', (req, res, next) => {
        res.header('Access-Control-Allow-Origin', "*");
        next();
    });

    app.use('/other_asset', beforeProxy('/other_asset'));
    app.use('/js/pc', proxyPC);
    app.use('/js/h5', proxyH5);
    
    httpsServer = https.createServer(options, app);
    httpServer.listen(443, 'm.asset.com', (err) => {
        if (err) {
            console.log(err);
            return;
        }
    });
}
```