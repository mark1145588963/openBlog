---
layout: post
title: "koa2一部分源码的解析"
subtitle: 'koa2 source code analysis'
author: "markzhang"
header-style: text
tags:
  - node koa2
---

从18年下半年以来开始涉足node开发以来，算起来使用koa2也快接近一年了。在使用koa2过程中对于项目由陌生到熟悉，于是想着写一篇总结来归纳自己对于koa2的理解和认识。

这篇文章会按照以下五个模块进行组织：中间件机制、context对象、request对象、response对象、启动服务。

## 中间件机制
我们通常在项目是通过以下方式来使用中间件的
```javascript
let bodyParser = require('koa-bodyparser')
app.use(bodyParser({
  forLimit: '4mb'
}));
```
我们可以猜想到use这个函数的作用是对要运行的中间件进行收集，那让我们来看一下源码
```javascript
function use(fn) {
  if (typeof fn !== 'function') throw new TypeError('middleware must be a function!');
  // 新版本的koa使用了async wait的语法，所以检测generator函数进行转化，并引导用户使用新的语法
  if (isGeneratorFunction(fn)) {
    deprecate('Support for generators will be removed in v3. ' +
                'See the documentation for examples of how to convert old middleware ' +
                'https://github.com/koajs/koa/blob/master/docs/migration.md');
    fn = convert(fn);
  }
  // this.middleware是一个数组，存放中间件函数
  this.middleware.push(fn);
  return this;
}
```